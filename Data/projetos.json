from datetime import date
import json
import Storage
import Services

projetos = {}
proximo_id = 1

def validar_cadastro(dados_projeto, id=None):
    projetos_existentes, _ = Storage.carregar_dados('projetos')
    nome = dados_projeto['nome']
    nome_projeto_upper = nome.strip().upper()
    for projeto_id, projeto_dados in projetos_existentes.items():
        if projeto_dados.get('nome_upper')==nome_projeto_upper and projeto_id != id:
            print("Esse nome de projeto já existe.")
            return False
    return True

def verifyTXT():
    while True:
        try:
            x = int(input())
            if(x<0 or x>5):
                print("O número não corresponde com as opções. Tente novamente")
                continue
        except ValueError:
            print("Você não digitou um número. Tente novamente")
            continue
        break
    return x


def check_id(projeto_id):
    return Services.buscar_id('projetos', projeto_id) is not None

def obterdatas():
    lista1 = [1, 3, 5, 7, 8, 10, 12]
    lista2 = [4, 6, 9, 11]
    while True:
        try:
            ano = int(input("Digite o ano de início do projeto: "))
            if ano < 1 or ano > 9999:
                print("Ano fora do alcance. Tente novamente.")
                continue
        except ValueError:
            print("O ano só contém números. Tente novamente")
            continue
        break

    while True:
        try:
            mes = int(input("Digite o mês de início do projeto (1-12): "))
            if mes < 1 or mes > 12:
                print("O número do mês deve ser de 1-12. Tente novamente")
                continue
        except ValueError:
            print("O mês só contém números. Tente novamente")
            continue
        break

    while True:
        if mes in lista1:
            try:
                dia = int(input("Digite o dia de início do projeto (1-31): "))
                if dia < 1 or dia > 31:
                    print("O número do dia deve ser de 1-31. Tente novamente")
                    continue
            except ValueError:
                print("O dia só contém números. Tente novamente")
                continue
        elif mes in lista2:
            try:
                dia = int(input("Digite o dia de início do projeto (1-30): "))
                if dia < 1 or dia > 30:
                    print("O número do dia deve ser de 1-30. Tente novamente")
                    continue
            except ValueError:
                print("O dia só contém números. Tente novamente")
                continue
        elif mes == 2 and ano % 4 == 0:
            try:
                dia = int(input("Digite o dia de início do projeto (1-29): "))
                if dia < 1 or dia > 29:
                    print("O número do dia deve ser de 1-29. Tente novamente")
                    continue
            except ValueError:
                print("O dia só contém números. Tente novamente")
                continue

        else:
            try:
                dia = int(input("Digite o dia de início do projeto (1-28): "))
                if dia < 1 or dia > 28:
                    print("O número do dia deve ser de 1-28. Tente novamente")
                    continue
            except ValueError:
                print("O dia só contém números. Tente novamente")
                continue

        break

    while True:
        try:
            simnao = int(input("Você possui data de término do projeto? Digite 1 se tiver e 2 se não tiver: "))
            if simnao < 1 or simnao > 2:
                print("Digite 1 ou 2")
                continue
        except ValueError:
            print("Digite 1 ou 2")
            continue
        break



    if simnao == 1:
        while True:
            try:
                ano2 = int(input("Digite o ano de término do projeto: "))
                if ano2 < ano:
                    print("Você não terminou o projeto antes de iniciar. Tente novamente.")
                    continue
            except ValueError:
                print("O ano só contém números. Tente novamente")
                continue
            break

        while True:
            try:
                mes2 = int(input("Digite o mês de término do projeto (1-12): "))
                if mes2 < 1 or mes2 > 12:
                    print("O número do mês deve ser de 1-12. Tente novamente")
                    continue
                if ano2 == ano and mes2 < mes:
                    print("Você não terminou o projeto antes de iniciar. Tente novamente.")
                    continue
            except ValueError:
                print("O mês só contém números. Tente novamente")
                continue
            break

        while True:
            if mes2 in lista1:
                try:
                    dia2 = int(input("Digite o dia de término do projeto (1-31): "))
                    if dia2 < 1 or dia2 > 31:
                        print("O número do dia deve ser de 1-31. Tente novamente")
                        continue
                except ValueError:
                    print("O dia só contém números. Tente novamente")
                    continue
            elif mes2 in lista2:
                try:
                    dia2 = int(input("Digite o dia de término do projeto (1-30): "))
                    if dia2 < 1 or dia2 > 30:
                        print("O número do dia deve ser de 1-30. Tente novamente")
                        continue
                except ValueError:
                    print("O dia só contém números. Tente novamente")
                    continue
            elif mes2 == 2 and ano2 % 4 == 0:
                try:
                    dia2 = int(input("Digite o dia de término do projeto (1-29): "))
                    if dia2 < 1 or dia2 > 29:
                        print("O número do dia deve ser de 1-29. Tente novamente")
                        continue
                except ValueError:
                    print("O dia só contém números. Tente novamente")
                    continue

            else:
                try:
                    dia2 = int(input("Digite o dia de término do projeto (1-28): "))
                    if dia2 < 1 or dia2 > 28:
                        print("O número do dia deve ser de 1-28. Tente novamente")
                        continue
                except ValueError:
                    print("O dia só contém números. Tente novamente")
                    continue

            if ano2 == ano and mes2 == mes and dia2 < dia:
                print("Você não terminou o projeto antes de iniciar. Tente novamente.")
                continue

            break
        dataI = date(ano, mes, dia)
        dataI = dataI.strftime('%d-%m-%Y')
        dataT = date(ano2, mes2, dia2)
        dataT = dataT.strftime('%d-%m-%Y')
        datas = (dataI, dataT)
        return datas
    if simnao == 2:
        dataI = date(ano, mes, dia)
        dataI = dataI.strftime('%d-%m-%Y')
        dataT = None
        datas = (dataI, dataT)
        return datas
        
def simsair(p):
    p = p.strip().lower() 
    if p == 'sim':
        return '1'
    elif p == 'sair':
        return '2'
    else:
        while p != 'sim' and p != 'sair':
            p = input("Opção inválida! Tente novamente (Sim para continuar, Sair para voltar): ").strip().lower()
        return '1' if p == 'sim' else '2'

def Menu_Projeto():
    global projetos
    global proximo_id
    
    while True:
        print('''==== Projetos ====
[1] Cadastrar Projeto
[2] Listar Projetos
[3] Buscar Projetos
[4] Atualizar Projetos
[5] Remover Projetos
[0] Voltar''')
        print("Digite o número da opção que deseja selecionar: ")
        x = verifyTXT()
        if (x==0):
            print("Voltando...")
            return
        
        while (x==1):
            while True:
                nome = input("Escreva o nome do seu projeto (NOME ÚNICO): ").strip() #strip() serve para o nome não poder ser só "         ", porque ele tira os espaços do começo e do final (mas não tira os espaços do meio)
                if not nome:
                    continue

                nomes = {"nome": nome, "nome_upper": nome.upper()}
                if validar_cadastro(nomes):
                    break
                else:
                    continue
            
            
            desc = input("Digite a descrição do seu projeto: ")
            data = obterdatas()
            dados_para_salvar = {
                "nome": nome,
                "nome_upper": nome.upper(),
                "descrição": desc,
                "início": data[0],
                "fim": data[1]
            }
            
            id_formatado, mensagem = Services.criar('projetos', dados_para_salvar)
            
            if id_formatado:
                print(f"Projeto '{nome}' cadastrado com sucesso! ID: {id_formatado}")
                break
            else:
                print(f"Falha ao cadastrar: {mensagem}")
                continue

    
        if (x==2):
            projetos_atuais, _ =Storage.carregar_dados('projetos')
            if not projetos_atuais:
                print("Nenhum projeto cadastrado.")
            else:
                print("\nLista de Projetos:")
                for projeto_id, dados in projetos_atuais.items():
                    print(f"  **ID**: {projeto_id}, **Nome**: {dados['nome']}, **Descrição**: {dados['descrição']}, **Início**: {dados['início']}, **Fim**: {dados['fim'] or 'N/A'}")
            y = input("Digite qualquer coisa para voltar ao menu: ")
            continue

        while (x==3): 
            z = input("Escreva o ID (ex: p_001) ou o nome do projeto que deseja buscar: ").strip().upper()
            projeto_encontrado = None
            
            if check_id(z.lower()):
                 projeto_encontrado = Services.buscar_id('projetos', z.lower())

            else:
                projetos_atuais, _ = Storage.carregar_dados('projetos')
                for dados in projetos_atuais.values():
                    if dados.get('nome_upper') == z:
                        projeto_encontrado = dados
                        break

            if projeto_encontrado:
                print(f'\n--- Projeto Encontrado (ID: {projeto_encontrado["id"]}) ---')
                print(f'Nome: {projeto_encontrado["nome"]}')
                print(f'Descrição: {projeto_encontrado["descrição"]}')
                print(f'Início: {projeto_encontrado["início"]}')
                print(f'Fim: {projeto_encontrado["fim"] or "Não definido"}')
                print('-------------------------------------------')
                input("Digite qualquer coisa para voltar ao menu: ")
                break
            else:
                p = input('Projeto não encontrado. Deseja continuar pesquisando? Digite "Sim" para continuar pesquisando.\nSe quiser sair, digite "Sair": ')
                if simsair(p) == '2':
                    break
        while(x==4):
            a = input("Digite o ID do projeto que deseja atualizar, ou digite Sair para voltar ao menu: ").strip().lower()
            if a == 'sair':
                break
            projeto_antigo=Services.buscar_id('projetos', a)
            if not projeto_antigo:
                print("Seu projeto não foi encontrado pelo ID.")
                continue

            projeto_id_atualizar = a
            print(f"\nAtualizando projeto ID: {projeto_id_atualizar} (Nome atual: {projeto_antigo.get('nome')})")
            while True:
                novonome = input("Digite o novo nome do projeto: ").strip()
                if not novonome:
                    continue
                novonomes = {"nome": novonome, "nome_upper": novonome.upper()}
                if validar_cadastro(novonomes, id=projeto_id_atualizar):
                    break
                else:
                    continue
            
            novadesc = input("Digite a descrição do projeto: ")
            novasdatas = obterdatas()
            dados_salvar = {
                "nome": novonome,
                "nome_upper": novonome.upper(),
                "descrição": novadesc,
                "início": novasdatas[0],
                "fim": novasdatas[1]
            }
            sucesso, mensagem = Services.atualizar('projetos', projeto_id_atualizar, dados_salvar)
            if sucesso:
                print(f"Projeto {projeto_id_atualizar} atualizado!")
                break
            else:
                print(f"Falha ao atualizar: {mensagem}")
                continue

        if x==5:
            while True:
                b = input("Escreva o ID do projeto que deseja remover (ex: p_001). Digite Sair para sair: ").strip().lower()
                if b == 'sair':
                    break
                if not check_id(b):
                    p = input('''Projeto não encontrado. Deseja continuar pesquisando? Digite "Sim" para continuar pesquisando.
Se quiser sair, digite "Sair": ''')
                    if simsair(p) == '2':
                        break
                    continue
                else:
                    sucesso, mensagem = Services.remover_por_id('projetos', b)
                    if sucesso:
                        print(f"Projeto com id {b} removido com sucesso!")
                        continue
            print("Removido com sucesso!")
            continue

