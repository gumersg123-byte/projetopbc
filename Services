import Storage
import Projetos

def formatar_id(id_int, prefixo='p'):
    return f"{prefixo}_{id_int:03d}"

def _obter_modulo_e_dados(modulo):
    return Storage.carregar_dados(modulo)

def _verificar_regras_especificas(modulo, dados, id_atual=None):
    if modulo == 'projetos':
        return Projetos.validar_cadastro(dados, id_atual)
    return True

def criar(modulo, dados_do_item):
    dados_dict, proximo_id = _obter_modulo_e_dados(modulo)
    
    if not _verificar_regras_especificas(modulo, dados_do_item):
        return None, "Falha na validação das regras específicas do módulo."
    
    prefixo = modulo[0]
    id_formatado = formatar_id(proximo_id, prefixo)
    
    dados_do_item['id'] = id_formatado
    
    dados_dict[id_formatado] = dados_do_item
    
    proximo_id += 1
    Storage.salvar_dados(modulo, dados_dict, proximo_id)
    return id_formatado, "Criado com sucesso."

def buscar_id(modulo, id_formatado):
    dados_dict, _ = _obter_modulo_e_dados(modulo)
    return dados_dict.get(id_formatado.lower())

def atualizar(modulo, id_formatado, novos_dados):
    dados_dict, proximo_id = _obter_modulo_e_dados(modulo)
    id_lower = id_formatado.lower()

    if id_lower not in dados_dict:
        return False, "ID não encontrado para atualização."
        
    if not _verificar_regras_especificas(modulo, novos_dados, id_lower):
        return False, "Falha na validação das regras específicas do módulo."

    novos_dados['id'] = id_lower
    dados_dict[id_lower] = novos_dados
    
    Storage.salvar_dados(modulo, dados_dict, proximo_id)
    return True, "Atualizado com sucesso."

def remover_por_id(modulo, id_formatado):
    dados_dict, proximo_id = _obter_modulo_e_dados(modulo)
    id_lower = id_formatado.lower()

    if id_lower in dados_dict:
        del dados_dict[id_lower]
        Storage.salvar_dados(modulo, dados_dict, proximo_id)
        return True, "Removido com sucesso."
    return False, "ID não encontrado para remoção."
